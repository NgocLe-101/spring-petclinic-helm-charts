{{- if .Values.istio.ingress.enabled }}
# VirtualService to route traffic from Gateway to internal services
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: petclinic-ingress
  namespace: {{ .Values.namespace }}
spec:
  hosts:
  - "*"  # Accept any host (works with IP addresses)
  gateways:
  - petclinic-gateway  # Reference the Gateway resource
  http:
  # Route for Grafana (must come before / catch-all)
  - match:
    - uri:
        prefix: "/grafana"
    rewrite:
      uri: "/"  # Remove /grafana prefix when forwarding
    route:
    - destination:
        host: grafana-server
        port:
          number: 3000
  # Route for Zipkin Tracing
  - match:
    - uri:
        prefix: "/zipkin"
    route:
    - destination:
        host: tracing-server
        port:
          number: 9411
  # Route for Prometheus
  - match:
    - uri:
        prefix: "/prometheus"
    route:
    - destination:
        host: prometheus-service
        port:
          number: 9090
  # Route for API Gateway (main application) - must be last as it's a catch-all
  - match:
    - uri:
        prefix: "/"
    route:
    - destination:
        host: api-gateway
        port:
          number: 8080
{{- end }}
